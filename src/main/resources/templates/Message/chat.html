<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Chat</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/chat-style.css">
</head>
<body>
<div class="container mt-4">
    <div class="chat-shell row g-0">
        <!-- Cá»™t trÃ¡i -->
        <div class="left-pane col-md-4 col-lg-3">
            <h5 class="section-title">ğŸ‘¥ NgÆ°á»i dÃ¹ng</h5>
            <!-- (tuá»³ chá»n) Ã´ tÃ¬m kiáº¿m user
                <div class="user-search">
                  <input type="text" class="form-control form-control-sm" placeholder="TÃ¬m kiáº¿m...">
                </div>
                -->
            <ul class="list-group" id="user-list">
                <li th:each="u : ${users}"
                    th:if="${u.id} != ${currentUserId}"
                    class="list-group-item list-group-item-action user-item"
                    th:attr="data-user-id=${u.id}, data-user-name=${u.fullname}"
                    th:text="${u.fullname}">
                </li>
            </ul>
        </div>

        <!-- Cá»™t pháº£i -->
        <div class="right-pane col-md-8 col-lg-9">
            <h5 id="chat-with">ğŸ’¬ Chá»n ngÆ°á»i Ä‘á»ƒ báº¯t Ä‘áº§u chat</h5>
            <div id="chat-box" class="mb-3"></div>
            <div class="composer">
                <input type="text" id="messageInput" class="form-control" placeholder="Nháº­p tin nháº¯n...">
                <button id="sendBtn" class="btn btn-primary" onclick="sendMessage()" disabled>Gá»­i</button>
            </div>
        </div>
    </div>
</div>

<!-- âœ… Sá»­ dá»¥ng link chuáº©n classic -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<script th:inline="javascript">

    const username = /*[[${username}]]*/ "áº©n"; // Thymeleaf truyá»n username
      const currentUserId = /*[[${currentUserId}]]*/ 0; // Thymeleaf truyá»n ID

      let stompClient;
      let isConnected = false;
      let currentConversationId = null;
      let currentReceiverId = null;
      let currentSubscription = null;

      // escape Ä‘á»ƒ trÃ¡nh XSS khi render text
      function escapeHtml(str) {
        return String(str).replace(/[&<>"']/g, s => (
          { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s]
        ));
      }

      function renderMessage(senderId, senderName, content) {
        const chatBox = document.getElementById("chat-box");
        const isMe = (String(senderId) === String(currentUserId)); // ğŸ‘ˆ so ID
        const label = isMe ? "Báº¡n" : senderName;

        chatBox.insertAdjacentHTML('beforeend', `
          <div class="msg ${isMe ? 'me' : 'other'}">
            <div class="sender">${escapeHtml(label)}</div>
            <div class="bubble">${escapeHtml(content)}</div>
          </div>
        `);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      window.onload = function () {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
          isConnected = true;
          console.log("âœ… WebSocket:", frame);
        }, function (error) {
          console.error("âŒ WS lá»—i:", error);
        });

        // click user + active
        document.querySelectorAll('.user-item').forEach(item => {
          item.addEventListener('click', () => {
            document.querySelectorAll('.user-item').forEach(li => li.classList.remove('active'));
            item.classList.add('active');

            const userId = item.getAttribute('data-user-id');
            const userName = item.getAttribute('data-user-name');
            selectUser(userId, userName);
          });
        });

        // Enter Ä‘á»ƒ gá»­i
        const inputEl = document.getElementById("messageInput");
        inputEl.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            sendMessage();
          }
        });
      };

      function selectUser(userId, fullname) {
        currentReceiverId = userId;

        fetch(`/api/conversation/${userId}`)
          .then(res => {
            if (!res.ok) throw new Error("Lá»—i khi láº¥y conversationId");
            return res.json();
          })
          .then(conversationId => {
            currentConversationId = conversationId;
            document.getElementById("chat-with").innerText = "ğŸ’¬ Chat vá»›i " + fullname;
            document.getElementById("chat-box").innerHTML = "";

            // load lá»‹ch sá»­
            loadMessages(conversationId);

            if (currentSubscription) currentSubscription.unsubscribe();

            currentSubscription = stompClient.subscribe(
              `/topic/conversation.${conversationId}`,
              function (message) {
                const msg = JSON.parse(message.body);
                renderMessage(
                  msg.senderId,                           // ğŸ‘ˆ láº¥y senderId tá»« WS
                  msg.sender || "KhÃ´ng rÃµ ngÆ°á»i gá»­i",
                  msg.content || "Ná»™i dung tin nháº¯n khÃ´ng xÃ¡c Ä‘á»‹nh"
                );
              }
            );

            document.getElementById("sendBtn").disabled = false;
          })
          .catch(error => {
            console.error("âŒ Lá»—i khi láº¥y conversationId:", error);
            alert("KhÃ´ng thá»ƒ láº¥y thÃ´ng tin cuá»™c trÃ² chuyá»‡n.");
          });
      }

      function loadMessages(conversationId) {
        fetch(`/api/messages/${conversationId}`)
          .then(response => response.json())
          .then(messages => {
            const chatBox = document.getElementById("chat-box");
            chatBox.innerHTML = "";
            messages.forEach(msg => {
              renderMessage(
                msg.senderId,                          // ğŸ‘ˆ láº¥y senderId tá»« DTO
                msg.senderName || "KhÃ´ng xÃ¡c Ä‘á»‹nh",
                msg.content || "(trá»‘ng)"
              );
            });
          })
          .catch(error => {
            console.error("Lá»—i khi táº£i tin nháº¯n:", error);
          });
      }

      function sendMessage() {
        if (!isConnected || !currentConversationId || !currentReceiverId) {
          alert("â›” Vui lÃ²ng chá»n ngÆ°á»i Ä‘á»ƒ chat.");
          return;
        }

        const input = document.getElementById("messageInput");
        const content = input.value.trim();
        if (!content) return;

        const chatMessage = {
          sender: username,
          senderId: currentUserId,  // ğŸ‘ˆ thÃªm senderId vÃ o payload
          content: content,
          receiverId: currentReceiverId,
          conversationId: currentConversationId
        };

        stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(chatMessage));
        input.value = "";
      }
</script>
</body>
</html>
