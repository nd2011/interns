<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Chat</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
</head>
<body>
<div class="container mt-3">
    <div class="row">
        <!-- C·ªôt tr√°i: Danh s√°ch ng∆∞·ªùi d√πng -->
        <div class="col-md-3 border-end">
            <h5>üë• Ng∆∞·ªùi d√πng</h5>
            <ul class="list-group" id="user-list">
                <li th:each="u : ${users}"
                    class="list-group-item list-group-item-action user-item"
                    th:attr="data-user-id=${u.id}, data-user-name=${u.fullname}"
                    th:text="${u.fullname}">
                </li>

            </ul>
        </div>

        <!-- C·ªôt ph·∫£i: Giao di·ªán chat -->
        <div class="col-md-9">
            <h5 id="chat-with">üí¨ Ch·ªçn ng∆∞·ªùi ƒë·ªÉ b·∫Øt ƒë·∫ßu chat</h5>
            <div id="chat-box" class="border p-3 mb-2" style="height: 300px; overflow-y: scroll;"></div>
            <input type="text" id="messageInput" class="form-control mb-2" placeholder="Nh·∫≠p tin nh·∫Øn...">
            <button id="sendBtn" class="btn btn-primary" onclick="sendMessage()" disabled>G·ª≠i</button>
        </div>
    </div>
</div>

<!-- ‚úÖ S·ª≠ d·ª•ng link chu·∫©n classic -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>


<script>
    const username = /*[[${username}]]*/ "·∫©n"; // Thymeleaf truy·ªÅn username

    let stompClient;
    let isConnected = false;
    let currentConversationId = null;
    let currentReceiverId = null;
    let currentSubscription = null;

    window.onload = function () {
        console.log("üöÄ ƒêang kh·ªüi t·∫°o WebSocket...");
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            isConnected = true;
            console.log("‚úÖ ƒê√£ k·∫øt n·ªëi WebSocket:", frame);
        }, function (error) {
            console.error("‚ùå K·∫øt n·ªëi WebSocket th·∫•t b·∫°i:", error);
        });

        // G·∫Øn s·ª± ki·ªán ch·ªçn ng∆∞·ªùi d√πng t·ª´ danh s√°ch
        document.querySelectorAll('.user-item').forEach(item => {
            item.addEventListener('click', () => {
                const userId = item.getAttribute('data-user-id');
                const userName = item.getAttribute('data-user-name');
                selectUser(userId, userName);
            });
        });
    };

    function selectUser(userId, fullname) {
        currentReceiverId = userId;

        fetch(`/api/conversation/${userId}`)
            .then(res => {
                if (!res.ok) throw new Error("L·ªói khi l·∫•y conversationId");
                return res.json();
            })
            .then(conversationId => {
                currentConversationId = conversationId;
                document.getElementById("chat-with").innerText = "üí¨ Chat v·ªõi " + fullname;
                document.getElementById("chat-box").innerHTML = "";

                if (currentSubscription) {
                    currentSubscription.unsubscribe(); // H·ªßy subscription c≈©
                }

                currentSubscription = stompClient.subscribe(`/topic/conversation.${conversationId}`, function (message) {
                    const msg = JSON.parse(message.body);
                    const chatBox = document.getElementById("chat-box");
                    chatBox.innerHTML += `<div><b>${msg.sender}:</b> ${msg.content}</div>`;
                    chatBox.scrollTop = chatBox.scrollHeight;
                });

                document.getElementById("sendBtn").disabled = false;
            })
            .catch(error => {
                console.error("‚ùå L·ªói khi l·∫•y conversationId:", error);
                alert("Kh√¥ng th·ªÉ l·∫•y th√¥ng tin cu·ªôc tr√≤ chuy·ªán.");
            });
    }

    function sendMessage() {
        if (!isConnected || !currentConversationId || !currentReceiverId) {
            alert("‚õî Vui l√≤ng ch·ªçn ng∆∞·ªùi ƒë·ªÉ chat.");
            return;
        }

        const content = document.getElementById("messageInput").value.trim();
        if (!content) return;

        // ‚úÖ G·ª≠i ch·ªâ receiverId ‚Üí server s·∫Ω t√¨m conversation v√† broadcast
        stompClient.send("/app/chat.sendMessage", {}, JSON.stringify({
            sender: username,
            content: content,
            receiverId: currentReceiverId
        }));

        document.getElementById("messageInput").value = "";
    }
</script>
</body>
</html>
