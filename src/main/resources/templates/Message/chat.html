<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Chat</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
</head>
<body>
<div class="container mt-3">
    <h3>üí¨ Real-time Chat</h3>
    <div id="chat-box" class="border p-3 mb-2" style="height: 300px; overflow-y: scroll;"></div>
    <input type="text" id="messageInput" class="form-control mb-2" placeholder="Nh·∫≠p tin nh·∫Øn...">
    <button id="sendBtn" class="btn btn-primary" onclick="sendMessage()" disabled>G·ª≠i</button>
</div>

<!-- ‚úÖ S·ª≠ d·ª•ng link chu·∫©n classic -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>


<script>
    let stompClient;
    let isConnected = false;

    window.onload = function () {
        console.log("üöÄ ƒêang kh·ªüi t·∫°o k·∫øt n·ªëi WebSocket...");

        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            isConnected = true;
            console.log("‚úÖ WebSocket ƒë√£ k·∫øt n·ªëi:", frame);

            // B·∫≠t n√∫t g·ª≠i
            const sendBtn = document.getElementById("sendBtn");
            if (sendBtn) sendBtn.disabled = false;

            // L·∫Øng nghe tin nh·∫Øn t·ª´ server
            stompClient.subscribe('/topic/conversation.1', function (message) {
                const msg = JSON.parse(message.body);
                const chatBox = document.getElementById("chat-box");
                chatBox.innerHTML += `<div><b>${msg.sender}:</b> ${msg.content}</div>`;
                chatBox.scrollTop = chatBox.scrollHeight; // T·ª± cu·ªôn xu·ªëng
            });

        }, function (error) {
            console.error("‚ùå WebSocket k·∫øt n·ªëi th·∫•t b·∫°i:", error);
            alert("‚ö†Ô∏è Kh√¥ng th·ªÉ k·∫øt n·ªëi WebSocket. Ki·ªÉm tra server ho·∫∑c c·∫•u h√¨nh.");
        });

        // Ki·ªÉm tra sau 5 gi√¢y n·∫øu ch∆∞a k·∫øt n·ªëi
        setTimeout(() => {
            if (!isConnected) {
                alert("‚õî WebSocket v·∫´n ch∆∞a k·∫øt n·ªëi sau 5 gi√¢y.");
            }
        }, 5000);
    };

    function sendMessage() {
        if (!isConnected || !stompClient.connected) {
            alert("‚õî WebSocket ch∆∞a s·∫µn s√†ng. Vui l√≤ng ch·ªù k·∫øt n·ªëi...");
            return;
        }

        const content = document.getElementById("messageInput").value;
        if (!content.trim()) return;

        stompClient.send("/app/chat.sendMessage", {}, JSON.stringify({
            sender: "admin", // c√≥ th·ªÉ s·ª≠a th√†nh user th·∫≠t sau
            content: content,
            conversationId: 1
        }));

        document.getElementById("messageInput").value = "";
    }
</script>

</body>
</html>
