<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Chat</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/chat-style.css">
</head>
<body>
<div class="container mt-4">
    <div class="chat-shell row g-0">
        <!-- C·ªôt tr√°i -->
        <div class="left-pane col-md-4 col-lg-3">
            <h5 class="section-title">üë• Ng∆∞·ªùi d√πng</h5>
            <!-- (tu·ª≥ ch·ªçn) √¥ t√¨m ki·∫øm user
                <div class="user-search">
                  <input type="text" class="form-control form-control-sm" placeholder="T√¨m ki·∫øm...">
                </div>
                -->
            <ul class="list-group" id="user-list">
                <li th:each="u : ${users}"
                    th:if="${u.id} != ${currentUserId}"
                    class="list-group-item list-group-item-action user-item"
                    th:attr="data-user-id=${u.id}, data-user-name=${u.fullname}"
                    th:text="${u.fullname}">
                </li>
            </ul>
        </div>

        <!-- C·ªôt ph·∫£i -->
        <div class="right-pane col-md-8 col-lg-9">
            <h5 id="chat-with">üí¨ Ch·ªçn ng∆∞·ªùi ƒë·ªÉ b·∫Øt ƒë·∫ßu chat</h5>
            <div id="chat-box" class="mb-3"></div>
            <div class="composer">
                <input type="text" id="messageInput" class="form-control" placeholder="Nh·∫≠p tin nh·∫Øn...">
                <button id="sendBtn" class="btn btn-primary" onclick="sendMessage()" disabled>G·ª≠i</button>
            </div>
        </div>
    </div>
</div>

<!-- ‚úÖ S·ª≠ d·ª•ng link chu·∫©n classic -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<script th:inline="javascript">

    const username = /*[[${username}]]*/ "·∫©n"; // Thymeleaf truy·ªÅn username
      const currentUserId = /*[[${currentUserId}]]*/ 0; // Thymeleaf truy·ªÅn ID

      let stompClient;
      let isConnected = false;
      let currentConversationId = null;
      let currentReceiverId = null;
      let currentSubscription = null;

      // escape ƒë·ªÉ tr√°nh XSS khi render text
      function escapeHtml(str) {
        return String(str).replace(/[&<>"']/g, s => (
          { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s]
        ));
      }

      function renderMessage(senderId, senderName, content) {
        const chatBox = document.getElementById("chat-box");
        const isMe = (String(senderId) === String(currentUserId)); // üëà so ID
        const label = isMe ? "B·∫°n" : senderName;

        chatBox.insertAdjacentHTML('beforeend', `
          <div class="msg ${isMe ? 'me' : 'other'}">
            <div class="sender">${escapeHtml(label)}</div>
            <div class="bubble">${escapeHtml(content)}</div>
          </div>
        `);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      window.onload = function () {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
          isConnected = true;
          console.log("‚úÖ WebSocket:", frame);
        }, function (error) {
          console.error("‚ùå WS l·ªói:", error);
        });

        // click user + active
        document.querySelectorAll('.user-item').forEach(item => {
          item.addEventListener('click', () => {
            document.querySelectorAll('.user-item').forEach(li => li.classList.remove('active'));
            item.classList.add('active');

            const userId = item.getAttribute('data-user-id');
            const userName = item.getAttribute('data-user-name');
            selectUser(userId, userName);
          });
        });

        // Enter ƒë·ªÉ g·ª≠i
        const inputEl = document.getElementById("messageInput");
        inputEl.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            sendMessage();
          }
        });
      };

      async function selectUser(userId, fullname) {
        currentReceiverId = userId;
        document.getElementById("chat-with").innerText = "üí¨ Chat v·ªõi " + fullname;
        document.getElementById("chat-box").innerHTML = "<p class='text-muted text-center fst-italic'>ƒêang t·∫£i h·ªôi tho·∫°i...</p>";

        try {
          // ‚úÖ G·ªçi API ƒë·ªÉ l·∫•y ho·∫∑c t·ª± t·∫°o h·ªôi tho·∫°i (backend t·ª± x·ª≠ l√Ω)
          const res = await fetch(`/api/conversation/${userId}`, { credentials: "include" });

          // N·∫øu l·ªói 500 ho·∫∑c 404 (VD: DB tr·ªëng, user ch∆∞a c√≥)
          if (!res.ok) {
            console.warn("‚ö†Ô∏è T·∫°o m·ªõi h·ªôi tho·∫°i do kh√¥ng t√¨m th·∫•y cu·ªôc tr√≤ chuy·ªán c≈©...");
            // Th·ª≠ g·ªçi l·∫°i 1 l·∫ßn (backend findOrCreate ƒë√£ x·ª≠ l√Ω t·∫°o m·ªõi)
            const retry = await fetch(`/api/conversation/${userId}`, { credentials: "include" });
            if (!retry.ok) throw new Error("Kh√¥ng th·ªÉ t·∫°o h·ªôi tho·∫°i m·ªõi!");
            const conversationId = await retry.json();
            handleConversation(conversationId, fullname);
            return;
          }

          // ‚úÖ N·∫øu l·∫•y ƒë∆∞·ª£c ID b√¨nh th∆∞·ªùng
          const conversationId = await res.json();
          handleConversation(conversationId, fullname);

        } catch (error) {
          console.error("‚ùå L·ªói h·ªôi tho·∫°i:", error);
          document.getElementById("chat-box").innerHTML =
            "<p class='text-danger text-center'>Kh√¥ng th·ªÉ l·∫•y ho·∫∑c t·∫°o h·ªôi tho·∫°i.</p>";
        }
      }

      function handleConversation(conversationId, fullname) {
        currentConversationId = conversationId;
        console.log("üìÇ Conversation ID:", conversationId);

        // H·ªßy subscription c≈© n·∫øu c√≥
        if (currentSubscription) currentSubscription.unsubscribe();

        // ƒêƒÉng k√Ω l·∫Øng nghe WebSocket cho cu·ªôc tr√≤ chuy·ªán n√†y
        currentSubscription = stompClient.subscribe(
          `/topic/conversation.${conversationId}`,
          function (message) {
            const msg = JSON.parse(message.body);
            renderMessage(msg.senderId, msg.sender || "Kh√¥ng r√µ", msg.content || "(tr·ªëng)");
          }
        );

        // B·∫≠t n√∫t g·ª≠i v√† load l·ªãch s·ª≠
        document.getElementById("sendBtn").disabled = false;
        loadMessages(conversationId);
      }

      function loadMessages(conversationId) {
        fetch(`/api/messages/${conversationId}`, {
          credentials: "include"  // üëà b·∫Øt bu·ªôc th√™m
        })
          .then(response => response.json())
          .then(messages => {
            const chatBox = document.getElementById("chat-box");
            chatBox.innerHTML = "";
            messages.forEach(msg => {
              renderMessage(
                msg.senderId,                          // üëà l·∫•y senderId t·ª´ DTO
                msg.senderName || "Kh√¥ng x√°c ƒë·ªãnh",
                msg.content || "(tr·ªëng)"
              );
            });
          })
          .catch(error => {
            console.error("L·ªói khi t·∫£i tin nh·∫Øn:", error);
          });
      }

      function sendMessage() {
        if (!isConnected || !currentConversationId || !currentReceiverId) {
          alert("‚õî Vui l√≤ng ch·ªçn ng∆∞·ªùi ƒë·ªÉ chat.");
          return;
        }

        const input = document.getElementById("messageInput");
        const content = input.value.trim();
        if (!content) return;

        const chatMessage = {
          sender: username,
          senderId: currentUserId,  // üëà th√™m senderId v√†o payload
          content: content,
          receiverId: currentReceiverId,
          conversationId: currentConversationId
        };

        stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(chatMessage));
        input.value = "";
      }
</script>
</body>
</html>
