<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Chat</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
</head>
<body>
<div class="container mt-3">
    <div class="row">
        <!-- C·ªôt tr√°i: Danh s√°ch ng∆∞·ªùi d√πng -->
        <div class="col-md-3 border-end">
            <h5>üë• Ng∆∞·ªùi d√πng</h5>
            <ul class="list-group" id="user-list">
                <li th:each="u : ${users}"
                    class="list-group-item list-group-item-action user-item"
                    th:attr="data-user-id=${u.id}, data-user-name=${u.fullname}"
                    th:text="${u.fullname}">
                </li>

            </ul>
        </div>

        <!-- C·ªôt ph·∫£i: Giao di·ªán chat -->
        <div class="col-md-9">
            <h5 id="chat-with">üí¨ Ch·ªçn ng∆∞·ªùi ƒë·ªÉ b·∫Øt ƒë·∫ßu chat</h5>
            <div id="chat-box" class="border p-3 mb-2" style="max-height: 400px; overflow-y: scroll;"></div>
            <input type="text" id="messageInput" class="form-control mb-2" placeholder="Nh·∫≠p tin nh·∫Øn...">
            <button id="sendBtn" class="btn btn-primary" onclick="sendMessage()" disabled>G·ª≠i</button>
        </div>


    </div>
</div>

<!-- ‚úÖ S·ª≠ d·ª•ng link chu·∫©n classic -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>


<script>
    const username = /*[[${username}]]*/ "·∫©n"; // Thymeleaf truy·ªÅn username

  let stompClient;
  let isConnected = false;
  let currentConversationId = null;
  let currentReceiverId = null;
  let currentSubscription = null;

  window.onload = function () {
      console.log("üöÄ ƒêang kh·ªüi t·∫°o WebSocket...");
      const socket = new SockJS('/ws');
      stompClient = Stomp.over(socket);

      stompClient.connect({}, function (frame) {
          isConnected = true;
          console.log("‚úÖ ƒê√£ k·∫øt n·ªëi WebSocket:", frame);
      }, function (error) {
          console.error("‚ùå K·∫øt n·ªëi WebSocket th·∫•t b·∫°i:", error);
      });

      // G·∫Øn s·ª± ki·ªán ch·ªçn ng∆∞·ªùi d√πng t·ª´ danh s√°ch
      document.querySelectorAll('.user-item').forEach(item => {
          item.addEventListener('click', () => {
              const userId = item.getAttribute('data-user-id');
              const userName = item.getAttribute('data-user-name');
              selectUser(userId, userName);
          });
      });
  };

  function selectUser(userId, fullname) {
    currentReceiverId = userId;

    // L·∫•y conversationId t·ª´ API
    fetch(`/api/conversation/${userId}`)
        .then(res => {
            if (!res.ok) throw new Error("L·ªói khi l·∫•y conversationId");
            return res.json();
        })
        .then(conversationId => {
            console.log("Conversation ID t·ª´ API: ", conversationId);
            currentConversationId = conversationId;
            document.getElementById("chat-with").innerText = "üí¨ Chat v·ªõi " + fullname;
            document.getElementById("chat-box").innerHTML = "";

            // L·∫•y c√°c tin nh·∫Øn t·ª´ API
            loadMessages(conversationId);  // G·ªçi API ƒë·ªÉ l·∫•y tin nh·∫Øn trong cu·ªôc tr√≤ chuy·ªán

            if (currentSubscription) {
                currentSubscription.unsubscribe(); // H·ªßy subscription c≈©
            }

            currentSubscription = stompClient.subscribe(`/topic/conversation.${conversationId}`, function (message) {
    const msg = JSON.parse(message.body);
    console.log("Tin nh·∫Øn nh·∫≠n ƒë∆∞·ª£c: ", msg);  // Ki·ªÉm tra tin nh·∫Øn nh·∫≠n ƒë∆∞·ª£c

    // ƒê·∫£m b·∫£o `msg.sender` v√† `msg.content` l√† chu·ªói
    const sender = msg.sender || "Kh√¥ng r√µ ng∆∞·ªùi g·ª≠i";  // Ki·ªÉm tra n·∫øu sender l√† null/undefined
    const content = msg.content || "N·ªôi dung tin nh·∫Øn kh√¥ng x√°c ƒë·ªãnh";  // Ki·ªÉm tra n·∫øu content l√† null/undefined

    const chatBox = document.getElementById("chat-box");
    chatBox.innerHTML += `<div><b>${sender}:</b> ${content}</div>`;
    chatBox.scrollTop = chatBox.scrollHeight;  // Cu·ªôn t·ªõi tin nh·∫Øn m·ªõi nh·∫•t
});


            document.getElementById("sendBtn").disabled = false;
        })
        .catch(error => {
            console.error("‚ùå L·ªói khi l·∫•y conversationId:", error);
            alert("Kh√¥ng th·ªÉ l·∫•y th√¥ng tin cu·ªôc tr√≤ chuy·ªán.");
        });
}

// H√†m ƒë·ªÉ t·∫£i c√°c tin nh·∫Øn t·ª´ API
function loadMessages(conversationId) {
    fetch(`/api/messages/${conversationId}`)  // G·ªçi API ƒë·ªÉ l·∫•y tin nh·∫Øn
        .then(response => response.json())  // Chuy·ªÉn ƒë·ªïi ph·∫£n h·ªìi JSON
        .then(messages => {
            console.log("Tin nh·∫Øn trong cu·ªôc tr√≤ chuy·ªán: ", messages);

            const chatBox = document.getElementById("chat-box");
            chatBox.innerHTML = "";  // X√≥a tin nh·∫Øn c≈© trong chat-box

            // Hi·ªÉn th·ªã t·∫•t c·∫£ tin nh·∫Øn
            messages.forEach(msg => {
                // Truy c·∫≠p v√†o c√°c thu·ªôc t√≠nh c·ªßa msg.sender v√† msg.content
                 const senderName = msg.senderName || "Kh√¥ng x√°c ƒë·ªãnh";
                const messageContent = msg.content || "(tr·ªëng)";


                chatBox.innerHTML += `<div><b>${senderName}:</b> ${messageContent}</div>`;
            });

            chatBox.scrollTop = chatBox.scrollHeight;  // Cu·ªôn ƒë·∫øn tin nh·∫Øn m·ªõi nh·∫•t
        })
        .catch(error => {
            console.error("L·ªói khi t·∫£i tin nh·∫Øn:", error);
        });
}

  function sendMessage() {
      if (!isConnected || !currentConversationId || !currentReceiverId) {
          alert("‚õî Vui l√≤ng ch·ªçn ng∆∞·ªùi ƒë·ªÉ chat.");
          return;
      }

      const content = document.getElementById("messageInput").value.trim();
      if (!content) return;

      // G·ª≠i tin nh·∫Øn t·ªõi WebSocket server
      const chatMessage = {
          sender: username,
          content: content,
          receiverId: currentReceiverId,
          conversationId: currentConversationId
      };

      stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(chatMessage));

      document.getElementById("messageInput").value = "";  // X√≥a n·ªôi dung tin nh·∫Øn
  }


</script>
</body>
</html>
