<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Quản lý nhiệm vụ dự án</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Link to the external CSS file -->
    <link rel="stylesheet" href="/css/task-style.css">
</head>
<body>
<h1>Quản lý nhiệm vụ dự án: <span th:text="${project.name}"></span></h1>

<div th:if="${success}" class="message success" th:text="${success}"></div>
<div th:if="${error}" class="message error" th:text="${error}"></div>

<form th:action="@{'/admin/projects/' + ${project.id} + '/tasks/create'}" method="post">
    <label>Tên nhiệm vụ:</label>
    <input type="text" name="name" required/>
    <br/>
    <label>Mô tả:</label>
    <textarea name="description"></textarea>
    <br/>
    <label>Giao cho:</label>
    <select name="assignedUserId" required>
        <option th:each="user : ${assignedUsers}" th:value="${user.id}" th:text="${user.fullname}"></option>
    </select>
    <br/>
    <label>Deadline:</label>
    <input type="date" name="deadline" required/>
    <br/>
    <button type="submit">Tạo nhiệm vụ</button>
</form>

<hr/>

<table border="1" cellpadding="5" cellspacing="0">
    <thead>
    <tr>
        <th>ID</th>
        <th>Nhiệm vụ</th>
        <th>Người làm</th>
        <th>Deadline</th>
        <th>Trạng thái</th>
        <th>Hành động</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="task : ${tasks}">
        <td th:text="${task.id}"></td>
        <td th:text="${task.name}"></td>
        <td th:text="${task.assignedUser.fullname}"></td>
        <td th:text="${task.deadlineFormatted}"></td>
        <td th:text="${task.status}"></td>
        <td>
            <form th:action="@{'/admin/tasks/' + ${task.id} + '/toggle-status'}" method="post" style="display:inline;">
                <button type="submit"
                        th:text="${task.status == 'DONE' ? 'Đánh dấu chưa hoàn thành' : 'hoàn thành'}"></button>
            </form>
            <form th:action="@{'/admin/tasks/' + ${task.id} + '/reject'}" method="post" style="display:inline; margin-left:5px;">
                <button type="submit"
                        th:disabled="${task.status == 'REJECTED'}"
                        style="background-color:#e53935; color:white; border:none; padding:3px 10px; border-radius:5px;"
                        onclick="return confirm('Bạn chắc chắn muốn từ chối nhiệm vụ này?');">
                    Từ chối
                </button>
            </form>
        </td>

    </tr>
    </tbody>
</table>

<hr/>

<canvas id="taskStatusChart" width="300" height="300"></canvas>

<script th:inline="javascript">
    const doneCount = [[${doneTasks}]];
    const totalCount = [[${totalTasks}]];
    const pendingCount = totalCount - doneCount;

    const data = {
        labels: ['Hoàn thành', 'Chưa hoàn thành'],
        datasets: [{
            data: [doneCount, pendingCount],
            backgroundColor: ['#4caf50', '#f44336']
        }]
    };

    const config = {
        type: 'pie',
        data: data,
        options: {
            responsive: false
        }
    };

    new Chart(document.getElementById('taskStatusChart').getContext('2d'), config);
</script>

</body>
</html>
